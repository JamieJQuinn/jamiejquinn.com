<!doctype html><html lang=en-GB><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://jamiejquinn.com/static/favicon.ico><title>4 Tips on Making Simulations Bug Resistant | Jamie J Quinn</title>
<meta name=title content="4 Tips on Making Simulations Bug Resistant"><meta name=description content="Having written and used a decent number of simulations over the past few years I&rsquo;ve come to understand that preventing bugs in scientific software is just a wee bit different from how it&rsquo;s usually done in more standard software development.
For one thing, many of the simulations come under the category of high performance computing (HPC) simulations, so it can take a long time to build and run a test case, leading to iteration speeds that are painfully slow."><meta name=keywords content="code,mathematics,debugging,hpc,simulations,"><meta property="og:url" content="https://jamiejquinn.com/4-tips-on-making-simulations-bug-resistant/"><meta property="og:site_name" content="Jamie J Quinn"><meta property="og:title" content="4 Tips on Making Simulations Bug Resistant"><meta property="og:description" content="Having written and used a decent number of simulations over the past few years I&amp;rsquo;ve come to understand that preventing bugs in scientific software is just a wee bit different from how it&amp;rsquo;s usually done in more standard software development.
For one thing, many of the simulations come under the category of high performance computing (HPC) simulations, so it can take a long time to build and run a test case, leading to iteration speeds that are painfully slow."><meta property="og:locale" content="en-GB"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-05-19T00:00:00+00:00"><meta property="article:modified_time" content="2017-05-19T00:00:00+00:00"><meta property="article:tag" content="Code"><meta property="article:tag" content="Mathematics"><meta property="article:tag" content="Debugging"><meta property="article:tag" content="Hpc"><meta property="article:tag" content="Simulations"><meta property="og:image" content="https://jamiejquinn.com/images/share.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://jamiejquinn.com/images/share.png"><meta name=twitter:title content="4 Tips on Making Simulations Bug Resistant"><meta name=twitter:description content="Having written and used a decent number of simulations over the past few years I&rsquo;ve come to understand that preventing bugs in scientific software is just a wee bit different from how it&rsquo;s usually done in more standard software development.
For one thing, many of the simulations come under the category of high performance computing (HPC) simulations, so it can take a long time to build and run a test case, leading to iteration speeds that are painfully slow."><meta itemprop=name content="4 Tips on Making Simulations Bug Resistant"><meta itemprop=description content="Having written and used a decent number of simulations over the past few years I&rsquo;ve come to understand that preventing bugs in scientific software is just a wee bit different from how it&rsquo;s usually done in more standard software development.
For one thing, many of the simulations come under the category of high performance computing (HPC) simulations, so it can take a long time to build and run a test case, leading to iteration speeds that are painfully slow."><meta itemprop=datePublished content="2017-05-19T00:00:00+00:00"><meta itemprop=dateModified content="2017-05-19T00:00:00+00:00"><meta itemprop=wordCount content="1469"><meta itemprop=image content="https://jamiejquinn.com/images/share.png"><meta itemprop=keywords content="Code,Mathematics,Debugging,Hpc,Simulations"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{text-decoration:none;color:#c50}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%;display:block;margin-left:auto;margin-right:auto}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#3273dc}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"]]}}</script></head><body><header><a href=/ class=title><h2>Jamie J Quinn / 4 Tips on Making Simulations Bug Resistant</h2></a><nav><a href=/>Home</a>
<a href=/blog/>Blog</a>
<a href=/presentations/>Presentations</a>
<a href=/projects/>Projects</a>
<a href=/publications/>Publications</a>
<a href=http://art.jamiejquinn.com>Art</a>
<a href=/jamie_quinn_cv.pdf>CV</a></nav></header><main><h1>4 Tips on Making Simulations Bug Resistant</h1><p><i><time datetime=2017-05-19 pubdate>19 May, 2017</time></i></p><content><p>Having written and used a decent number of simulations over the past few years I&rsquo;ve come to understand that preventing bugs in scientific software is just a wee bit different from how it&rsquo;s usually done in more standard software development.</p><p>For one thing, many of the simulations come under the category of high performance computing (HPC) simulations, so it can take a long time to build and run a test case, leading to iteration speeds that are <em>painfully</em> slow. Another feature of simulations is that sometimes the code isn&rsquo;t that complex in software terms, the programs simply iterates over a large number of equations, which itself comes with a pitfalls. Debugging is also a nightmare, not because something goes terribly wrong and the program crashes, that&rsquo;s not too hard to fix, but what are you meant to do when a graph your simulation produces is just a little bit too tall? Or the fluid you&rsquo;re simulating inexplicably only goes one way? Is the problem in your theory or in your code?</p><p>In light of this, here are a few tips that have saved me a lot of bother in the past, and might save you in the future.</p><h2 id=1-unit-test>1. Unit Test</h2><p>I&rsquo;m going to get this one out of the way quickly. I know unit testing is an obvious one to most software developers, but I also know that many scientists who program do not consider themselves developers. At any rate, unit testing is kind of hard, especially when common HPC languages like fortran and C aren&rsquo;t exactly the most accommodating of languages for unit testing, and even more so when you consider how many parts of a simulation just aren&rsquo;t unit testable.</p><p>Taking that into account my advice is this:</p><ul><li>Set up a unit testing library in your language of choice</li><li>Learn how to write a basic test in it</li><li>Test the living crap out of every bit you can, eg<ul><li>Derivatives and mathematical helper functions</li><li>System of equation solvers</li><li>Functions that deal with data in/out</li></ul></li></ul><p>Not only will you be able to show that much of your code works fine, but you&rsquo;ll hopefully write better, simpler functions.</p><p>Here&rsquo;s a reasonably simple example from a small 1D fluid simulation that I wrote. It tests the ability of a variable structure, <code>ModelVariables</code>, to save and load itself. It&rsquo;s just a simple, effective test, and it came in useful a few times when I made some breaking code change and knew about it <em>immediately</em> when this test failed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>TEST_CASE( <span style=color:#e6db74>&#34;ModelVariables save and load correctly&#34;</span>, <span style=color:#e6db74>&#34;[variables]&#34;</span> ) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Setup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> N <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>string filePath <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ModelVariableSaveTest.dat&#34;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> Constants <span style=color:#a6e22e>c</span>(<span style=color:#ae81ff>0.0001f</span>, <span style=color:#ae81ff>2.0f</span>, N, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>2.0f</span>, <span style=color:#ae81ff>3.0f</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  ModelVariables <span style=color:#a6e22e>vars</span>(c);
</span></span><span style=display:flex><span>  ModelVariables <span style=color:#a6e22e>vars2</span>(c);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Load in some test data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  real<span style=color:#f92672>*</span> data <span style=color:#f92672>=</span> vars.pressure.get();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>5</span>; <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>    data[i] <span style=color:#f92672>=</span> <span style=color:#ae81ff>4.0f</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Save it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  vars.save(filePath.c_str());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Load it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  vars2.load(filePath.c_str(), c);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>; i<span style=color:#f92672>&lt;</span>vars.len(); <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>    CHECK(vars.pressure[i] <span style=color:#f92672>==</span> vars2.pressure[i]);
</span></span><span style=display:flex><span>    CHECK(vars.density[i] <span style=color:#f92672>==</span> vars2.density[i]);
</span></span><span style=display:flex><span>    CHECK(vars.velocity[i] <span style=color:#f92672>==</span> vars2.velocity[i]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=2-line-equations-up>2. Line Equations Up</h2><p>Say you&rsquo;ve got multiple equations that have a symmetry to them, for example if you&rsquo;re working in 3D and you&rsquo;re calculating a similar thing in all three dimensions. Make it easy for your eyes to spot an error and line up your equations.</p><p>The following three lines of almost language-agnostic code should all be identical except from any <code>x</code> being replaced with <code>y</code> and <code>z</code>, a reasonably typical situation in a fluid dynamics simulation. There are 3 errors. Can you see them?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>bxx <span style=color:#f92672>=</span> c<span style=color:#f92672>*</span>bxx <span style=color:#f92672>-</span> a<span style=color:#f92672>*</span>bxx <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>x<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>pbxx
</span></span><span style=display:flex><span>byy <span style=color:#f92672>=</span> a<span style=color:#f92672>*</span>byy <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>x<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>pdyy <span style=color:#f92672>-</span> c<span style=color:#f92672>*</span>byy
</span></span><span style=display:flex><span>bzz <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>z<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> pbzz <span style=color:#f92672>+</span> o <span style=color:#f92672>*</span> bzz <span style=color:#f92672>-</span> a <span style=color:#f92672>*</span> bzz 
</span></span></code></pre></div><p>What if I do this?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>bxx <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>a<span style=color:#f92672>*</span>bxx <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>x<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>pbxx <span style=color:#f92672>+</span> c<span style=color:#f92672>*</span>bxx 
</span></span><span style=display:flex><span>byy <span style=color:#f92672>=</span>  a<span style=color:#f92672>*</span>byy <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>s<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>pdyy <span style=color:#f92672>-</span> c<span style=color:#f92672>*</span>byy
</span></span><span style=display:flex><span>bzz <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>a<span style=color:#f92672>*</span>bzz <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>z<span style=color:#f92672>**</span><span style=color:#ae81ff>2</span><span style=color:#f92672>*</span>pbzz <span style=color:#f92672>+</span> o<span style=color:#f92672>*</span>bzz  
</span></span></code></pre></div><p>Immediately you can see most of the errors clearly! The minus sign is in the wrong place in the <code>yy</code> equation, there&rsquo;s an <code>s</code> instead of an <code>y</code> too (woops, copy and paste is the devils work), there&rsquo;s an <code>o</code> instead of a <code>c</code> and a <code>d</code> instead of a <code>b</code>. You&rsquo;ll note that was actually 4 errors, because how often do you know how many errors you have in a piece of code?</p><p>Now certainly this is bad code as well because the names don&rsquo;t make immediate sense (see tip #3) and perhaps I should have brackets around the power, and yes the compiler might pick up some of these errors for you, but just look how much easier it is to spot little formatting errors that <em>could</em> cause you major headaches when a little time is taken to properly format the code.</p><h2 id=3-name-your-goddamn-variables>3. Name Your Goddamn Variables</h2><p>I did a maths degree at undergraduate level so I totally understand that when maths is written down it looks better as \(a = b_n + c\) than \(ants = bread_n + corn\). It&rsquo;s mainly because when you ram a bunch of symbols together like \(xyz\) you know that just means \(x\), \(y\) and \(z\) all multiplied together. This falls a bit short when an equation is translated into code. It looks like incomprehensible garbage unless you have a symbol chart in a comment somewhere (which will end up being wrong some time down the line) or you actually have the book or paper with the equation in it in front of you. Plus having one letter names make refactoring or even just searching for a variable <em>extremely</em> difficult.</p><p>Here&rsquo;s a real life example of when this habit of short variable names lead me to spend nearly an entire week debugging a small 2D fluid simulation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> n<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>; n<span style=color:#f92672>&lt;</span>Nn; <span style=color:#f92672>++</span>n) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> k<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>; k<span style=color:#f92672>&lt;</span>Nn<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#f92672>++</span>k) {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In line 2, that&rsquo;s not meant to be an <code>Nn</code>. That&rsquo;s meant to be an <code>Nz</code>, but it&rsquo;s nearly impossible to see!</p><p>A better way to do this is to name those variables something a little more meaningful. The variable <code>n</code> is actually counting the number of spectral modes in the code, so why not call <code>Nn</code> something better like <code>n_modes</code>. It&rsquo;s readable and its not going to get mixed up with <code>Nz</code>, especially if <code>Nz</code> is named something more readable like <code>n_points</code>, now a meaningful name since <code>k</code> is actually counting through the grid points.</p><p>Sometimes it can go too far however, especially when transcribing equations into code. Check out the next tip.</p><h2 id=4-do-as-little-as-possible>4. Do as Little as Possible</h2><blockquote><p>Every step between your equations and code is a source of error.</p></blockquote><p>As in many things, when writing simulations there is little scope for error, especially considering the results of the simulation are often untestable or the code takes so long to run that it&rsquo;s just impractical to test against real data. Even then, with complex simulations it&rsquo;s difficult to know whether differences between your simulation results and your experimental data are due to numerical inaccuracy, experimental issues, problems with the theory (but not the code) or straight up bugs in the code.</p><p>If you&rsquo;ve ever done any kind of mathematical derivation or proof or just some long-winded calculation, you know that you&rsquo;re going to make a mistake somewhere which means in turning any equations or theory into code you want to do it in as few steps as possible. That means, at least for a first version, the equations should be written in code as close to the originals as possible. There are two ways to do this and pros and cons to each.</p><ol><li>Write using the same (or close to the same) symbols. \(a = b \times c\) becomes <code>a = b*c</code>.</li><li>Write the equation in terms of what it means. \(a = b \times c\) becomes <code>apples = bananas*cantaloupe</code>.</li></ol><p>I tend to use the second style now, although I was very much a fan of the first style for years. The second style feels more natural to program in. Not only is it easier to search for <code>apples</code> than <code>a</code> but you can spot errors much more easily (see tip #3). The issue with it is that it&rsquo;s slightly more difficult to check against the original equation and formatting can get a little harder.</p><p>But you can make your own decision. I&rsquo;m not your mother.</p><h1 id=the-round-up>The Round Up</h1><p>In short,</p><ol><li>Unit test what you can</li><li>Use good formatting</li><li>Name your variables well</li><li>Don&rsquo;t over-complicate your equations</li></ol><p>Hopefully I&rsquo;ve presented some food for thought here. If you disagree with anything or just have any examples or comments, let me know!</p><p>Many of these ideas are inspired by Joel Spolsky&rsquo;s philosophy of making bad code look wrong. Do check out his <a href=https://www.joelonsoftware.com/2005/05/11/making-wrong-code-look-wrong/>blog post</a> for more ideas and philosophy on writing code that just looks wrong when it is. Code Complete is also a fantastic tome with some empirical evidence on how to improve your code style.</p></content><p><a href=https://jamiejquinn.com/tags/code/>#Code</a>
<a href=https://jamiejquinn.com/tags/mathematics/>#Mathematics</a>
<a href=https://jamiejquinn.com/tags/debugging/>#Debugging</a>
<a href=https://jamiejquinn.com/tags/hpc/>#Hpc</a>
<a href=https://jamiejquinn.com/tags/simulations/>#Simulations</a></p></main><footer><p><a href=mailto:jamiejquinn@jamiejquinn.com>Email</a> / <a href=https://www.github.com/jamiejquinn>Github</a> / <a href=https://www.instagram.com/jamiejquinn>Instagram</a> / <a href=https://twitter.com/jimjonquinn>Twitter</a></p></footer></body></html>